#textdomain wesnoth-Saving_Elensefar

[scenario]
    id=sea_voyage_swampland
    next_scenario=sea_voyage_0
    name= _ "The Swampland"
    victory_when_enemies_defeated=no
    disallow_recall=yes
    map_data="{~add-ons/Saving_Elensefar/maps/The_Swampland.map}"
    turns=-1

#define CLEAR_ITEMS
    {VARIABLE A 6}
    [while]
        {VARIABLE_CONDITIONAL A less_than 21}
        [do]
            {VARIABLE B 6}
            [while]
                {VARIABLE_CONDITIONAL B less_than 21}
                [do]
                    [remove_item]
                        x,y=$A,$B
                    [/remove_item]
                    {VARIABLE_OP B add 2}
                [/do]
            [/while]
            {CLEAR_VARIABLE B}
            {VARIABLE_OP A add 2}
        [/do]
    [/while]
    {CLEAR_VARIABLE A}
#enddef

    [event]
        name=calculate_value

        {VARIABLE_OP village_x sub 14}
        {VARIABLE_OP village_y sub 14}

        [if]
            {VARIABLE_CONDITIONAL village_x less_than 0}
            [then]
                {VARIABLE_OP village_x multiply -1}
            [/then]
            [else]
                {VARIABLE_OP village_x add 2}
            [/else]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL village_y less_than 0}
            [then]
                {VARIABLE_OP village_y multiply -1}
            [/then]
            [else]
                {VARIABLE_OP village_y add 2}
            [/else]
        [/if]

        {VARIABLE village_value "$($village_x*$village_y)"}
    [/event]

    [event]
        name=check_direction
        first_time_only=no

        {VARIABLE X $unit.x}
        {VARIABLE Y $unit.y}
        {VARIABLE_OP X add $x_dir}
        {VARIABLE_OP Y add $y_dir}

        # Count number of other side's checkers
        {VARIABLE enemies no}
        [while]
            [have_unit]
                [not]
                    side=$side_number
                [/not]
                x,y=$X,$Y
            [/have_unit]
            [do]
                {VARIABLE enemies yes}
                {VARIABLE_OP X add $x_dir}
                {VARIABLE_OP Y add $y_dir}
            [/do]
        [/while]

        # If other side has more than 1 checker and your unit is next
        [if]
            [have_unit]
                side=$side_number
                x,y=$Y,$Y
            [/have_unit]
            {VARIABLE_CONDITIONAL enemies equals yes}
            [then]
                [set_variables]
                    name=valid_locations
                    mode=append
                    [value]
                        x,y=$X,$Y
                    [/value]
                [/set_variables]
            [/then]
        [/if]
        {CLEAR_VARIABLE X,Y,enemies}
    [/event]

    [event]
        name=calculate_best_move
        first_time_only=no

        [store_locations]
            [filter]
                side=$side_number
            [/filter]
            variable=my_units
        [/store_locations]

        {FOREACH my_units i_temp}
            {VARIABLE x_dir -2}
            [while]
                {VARIABLE_CONDITIONAL x_dir less_than_equal_to 2}
                [do]
                    {VARIABLE y_dir -2}
                    [while]
                        {VARIABLE_CONDITIONAL y_dir less_than_equal_to 2}
                        [do]
                            [fire_event]
                                name=check_direction
                                [primary_unit]
                                    x,y=$my_units[$i_temp].x,$my_units[$i_temp].y
                                [/primary_unit]
                            [/fire_event]
                            {VARIABLE_OP y_dir add 2}
                        [/do]
                    [/while]
                    {VARIABLE_OP x_dir add 2}
                [/do]
            [/while]
            {CLEAR_VARIABLE x_dir,y_dir}
        {NEXT i_temp}

        {FOREACH valid_locations i_temp}
            [store_locations]
                find_in=villages
                [and]
                    x,y=$valid_locations[$i_temp].x,$valid_locations[$i_temp].y
                    radius=2
                [/and]
                [not]
                    [filter]
                        side=$side_number
                    [/filter]
                [/not]
                [not]
                    x,y=$valid_locations[$i_temp].x,$valid_locations[$i_temp].y
                [/not]
                variable=adjacent
            [/store_locations]

            {FOREACH adjacent j_temp}
                {VARIABLE village_x $adjacent[$j_temp].x}
                {VARIABLE village_y $adjacent[$j_temp].y}

                [fire_event]
                    name=calculate_value
                [/fire_event]

                {VARIABLE_OP total_value add $village_value}
            {NEXT j_temp}
            {CLEAR_VARIABLE adjacent}

            {VARIABLE village_x $valid_locations[$i_temp].x}
            {VARIABLE village_y $valid_locations[$i_temp].y}

            [fire_event]
                name=calculate_value
            [/fire_event]

            {VARIABLE village_worth "$($village_value-$total_value)"}

            [if]
                {VARIABLE_CONDITIONAL village_worth greater_than $best_worth}
                [then]
                    {VARIABLE best_worth $village_worth}
                    {VARIABLE valid_move yes}
                    {VARIABLE valid_x $valid_locations[$i_temp].x}
                    {VARIABLE valid_y $valid_locations[$i_temp].y}
                [/then]
            [/if]

#ifdef DEBUG_MODE
            [label]
                x,y=$valid_locations[$i_temp].x,$valid_locations[$i_temp].y
                text=$village_worth
            [/label]
#endif
        {NEXT i_temp}
        {CLEAR_VARIABLE valid_locations,village_worth,total_value,village_x,village_y}
    [/event]

    [event]
        name=place_checker
        first_time_only=no

        {GENERIC_UNIT $valid_x $valid_y $unit_type $side_number}

        {VARIABLE x_dir -2}
        [while]
            {VARIABLE_CONDITIONAL x_dir less_than_equal_to 2}
            [do]
                {VARIABLE y_dir -2}
                [while]
                    {VARIABLE_CONDITIONAL y_dir less_than_equal_to 2}
                    [do]
                        {VARIABLE X $valid_x}
                        {VARIABLE Y $valid_y}

                        {VARIABLE_OP X add $x_dir}
                        {VARIABLE_OP Y add $y_dir}
                        [while]
                            [have_unit]
                                [not]
                                    side=$side_number
                                [/not]
                                x,y=$X,$Y
                            [/have_unit]
                            [do]
                                {MODIFY_UNIT (x,y=$X,$Y) side $side_number}
                                [capture_village]
                                    side=$side_number
                                    x,y=$X,$Y
                                [/capture_village]
                                {VARIABLE_OP X add $x_dir}
                                {VARIABLE_OP Y add $y_dir}
                            [/do]
                        [/while]
                        {CLEAR_VARIABLE x_dir,y_dir,X,Y}
                    [/event]

#define CHECK_GAME_OVER
    [store_unit]
        [filter]
            side=1
            canrecruit=no
            [not]
                x,y=recall,recall
            [/not]
        [/filter]
        variable=side_1_units
    [/store_unit]
    [store_unit]
        [filter]
            side=2
            canrecruit=no
        [/filter]
        variable=side_2_units
    [/store_unit]

    {REMOVE_LABEL 9 2}
    {SET_LABEL 9 2 "<span color='red'>$side_1_units.length|</span> <b>:</b> <span color='blue'>$side_2_units.length|</span>"}

    {IF_VAR side_1_units.length equals 0 (
        [then]
            [endlevel]
                result=defeat
            [/endlevel]
        [/then]
    )}

    {IF_VAR side_2_units.length equals 0 (
        [then]
            {MODIFY_UNIT id=Othello side 1}
            {SE_ENDLEVEL 0}
        [/then]
    )}

    [if]
        {VARIABLE_CONDITIONAL checker_count equals 60}
        [or]
            {VARIABLE_CONDITIONAL none_played equals yes}
        [/or]
        [then]
            [if]
                {VARIABLE_CONDITIONAL side_1_units.length greater_than_equal_to $side_2_units.length}
#ifdef HARD
                [and]
                    [have_unit]
                        side=1
                        id=Madru
                    [/have_unit]
                    [have_unit]
                        side=1
                        id="Black the Red"
                    [/have_unit]
                [/and]
#endif
#ifdef NORMAL
                [and]
                    [have_unit]
                        side=1
                        id=Madru
                    [/have_unit]
                    [or]
                        [have_unit]
                            side=1
                            id="Black the Red"
                        [/have_unit]
                    [/or]
                [/and]
#endif
                [then]
                    [message]
                        image="wesnoth-icon.png"
                        caption= _ "You win!"
                        message= _ "You: $side_1_units.length
Othello: $side_2_units.length"
                    [/message]
                    {IF_VAR none_played equals yes (
                        [then]
                            {MODIFY_UNIT id=Othello side 1}
                        [/then]
                        [else]
                            [kill]
                                id=Othello
                                fire_event=no
                                animate=no
                            [/kill]
                        [/else]
                    )}
                    {SE_ENDLEVEL 0}
                [/then]
                [else]
                    [message]
                        image="wesnoth-icon.png"
                        caption= _ "You lost."
                        message= _ "You: $side_1_units.length
Othello: $side_2_units.length"
                    [/message]
                    [endlevel]
                        result=defeat
                    [/endlevel]
                [/else]
            [/if]
        [/then]
    [/if]
    {CLEAR_VARIABLE side_1_units,side_2_units}
#enddef

#define RECALL_OR_CREATE_UNIT X Y TYPE
    [recall]
        side=1
        x,y={X},{Y}
    [/recall]
    [if]
        [not]
            [have_unit]
                side=1
                x,y={X},{Y}
            [/have_unit]
        [/not]
        [then]
            {GENERIC_UNIT 1 {TYPE} {X} {Y}}
        [/then]
    [/if]
#enddef

                    {SAVING_ELENSEFAR_SHEDULE}

                    {MOOD_NORMAL}
                    {VICTORY_AND_DEFEAT_MUSIC}
                    {SE_SCENARIO_MUSIC a3deap_HighInTheMountains}

                    {MENELDUR_SIDE}

                    [side]
                        side=2
                        controller=ai
                        id=Othello
                        name= _"Othello"
                        type=Necromancer
                        canrecruit=yes
                        gold=0
                        income=-2
                        team_name=bad
                        user_team_name= _"Crazy Horse"
                        village_gold=0
                        recruit=""
                        unrenamable=yes
#ifdef EASY
                        extra_recruit=Walking Corpse,Soulless,Ghoul,Vampire Bat,Blood Bat
#else
                        extra_recruit=Walking Corpse,Ghoul,Vampire Bat
#endif
                        [filter_recall]
                            type={FILTER_UNDEAD_NON_SKELET}
                        [/filter_recall]
                        {IS_EXPENDABLE_LEADER}

                        {FLAG_VARIANT undead}
                        [ai]
                            ai_algorithm=idle_ai
                            {AI_NO_RECRUITMENT}
                        [/ai]
                    [/side]

                    [event]
                        name=prestart

                        [objectives]
                            side=1
                            summary= _ "Play a game of Reversi with Othello"
                            [objective]
                                description= _ "Capture more units than Othello does"
                                condition=win
                            [/objective]
                            [objective]
                                description= _ "Othello finish with more units"
                                condition=lose
                            [/objective]
#ifdef NORMAL
                            [objective]
                                description= _ "You lose <b>both</b> Madru and Black the Red"
                                condition=lose
                            [/objective]
#endif
#ifdef HARD
                            [objective]
                                description= _ "You lose <b>either</b> Madru or Black the Red"
                                condition=lose
                            [/objective]
#endif
                            notes_string=_"<b>How to Play</b>" # wmllint: ignore
                            [note]
                                description=_"A move is valid if Othello's units will be between two of yours. To place a unit on the board:"
                            [/note]
                            [note]
                                description=_"(1) Move Meneldur to a ruined castle at the bottom to select the column"
                            [/note]
                            [note]
                                description=_"(2) Move Meneldur again to a ruined castle now at the left to select the row"
                            [/note]
                            [note]
                                description=_"(3) If the move is valid an unit will be recalled at the given place"
                            [/note]
                            [note]
                                description=_"(4) And any enemy units standing between two of yours will swap side."
                            [/note]
                            [note]
                                description=_"(5) The game continues until the board is full, or neither leader could do a move."
                            [/note]
                        [/objectives]
                    [/event]

                    [event]
                        name=start

                        [recall]
                            id=Madru
                            x,y=12,14
                        [/recall]

                        [recall]
                            id="Black the Red"
                            x,y=14,12
                        [/recall]

                        [fire_event]
                            name=fire_supply_calculation_start
                        [/fire_event]

                        [message]
                            id=Meneldur
                            message= _ "What is this, a mage walks clad in black? Explain yourself! Are you of the red mages, or the white?"
                        [/message]
                        [message]
                            id=Othello
                            message= _ "What? Do you mean to tell me that the great lich Jevyan does not reign on that continent, or that his mages no longer wear the robes of the necromancer?!?"
                        [/message]

                        {LOYAL_UNIT 2 (Revenant) 12 12}
                        [+unit]
                            animate=yes
                        [/unit]

                        {LOYAL_UNIT 2 (Necrophage) 14 14}

                        [message]
                            id=Madru
                            message= _ "What? Why do you speak of those old tales as if they were real? And I suppose you think you are a real necromancer too."
                        [/message]
                        [message]
                            id="Black the Red"
                            message= _ "Why do you say he's not a necromancer? I've seen them before, haven't you?"
                        [/message]
                        [message]
                            id=Meneldur
                            message= _ "Are you saying undead exist?"
                        [/message]
                        [message]
                            id="Black the Red"
                            message= _ "Yes. And this guy looks real enough. I think we should treat him like an actual enemy."
                        [/message]
                        [message]
                            id=Othello
                            message= _ "Yes, you should! Now, prepare to die!"
                        [/message]
                        [message]
                            id=Madru
                            message= _ "Whatever. We will see if he actually can raise anything, and if we come out of here."
                        [/message]

                        [object]
                            silent=yes
                            duration=scenario

                            [filter]
                                canrecruit=yes
                            [/filter]

                            [effect]
                                apply_to=new_animation

                                [animation]
                                    apply_to=pre_teleport
                                    {TELEPORT_OUT_ANIMATION}
                                [/animation]

                                [animation]
                                    apply_to=post_teleport
                                    {TELEPORT_IN_ANIMATION}
                                [/animation]
                            [/effect]
                            [effect]
                                apply_to=movement_costs
                                replace=yes
                                [movement_costs]
                                    flat=99
                                    sand=99
                                    swamp_water=99
                                [/movement_costs]
                            [/effect]
                        [/object]
                    [/event]

                    [event]
                        name=victory

                        [if]
                            [have_unit]
                                id=Othello
                                side=1
                            [/have_unit]
                            [then]
                                [message]
                                    id=Othello
                                    message= _ "Impressive. You were able to storm my game. May I join you on your quest?"
                                [/message]
                                [message]
                                    id=Meneldur
                                    message= _ "Err"
                                [/message]
                                [message]
                                    id="Black the Red"
                                    message= _ "Sure, we need any willing hand"
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    id=Meneldur
                                    message= _ "That was a weird battle..."
                                [/message]
                                [message]
                                    id=Madru
                                    message= _ "... in the magic castle."
                                [/message]
                                [message]
                                    id="Black the Red"
                                    message= _ "Look, we have gain more soldiers for our quest. Wy did you complain?"
                                [/message]
                            [/else]
                        [/if]

                        {CLEAR_VARIABLE valid_x,valid_y,valid_move,none_played}
                    [/event]

                    [event]
                        name=new turn
                        first_time_only=no

                        # teleport the leaders back to the keep
                        [teleport]
                            x,y=13,22
                            [filter]
                                id=Meneldur
                            [/filter]
                        [/teleport]

                        [teleport]
                            x,y=13,5
                            [filter]
                                id=Othello
                            [/filter]
                        [/teleport]

                        {CLEAR_VARIABLE none_played}

                        {VARIABLE valid_move no}
                    [/event]

                    [event]
                        name=turn refresh
                        first_time_only=no
                        {MODIFY_UNIT (canrecruit=no) moves 0}
                        {MODIFY_UNIT (canrecruit=yes) moves 16}
                    [/event]

                    [event]
                        name=moveto
                        first_time_only=no

                        [filter]
                            id=Meneldur
                        [/filter]

                        [modify_unit]
                            [filter]
                                id=Meneldur
                            [/filter]
                            moves=$this_unit.max_moves
                        [/modify_unit]

                        [if]
                            [have_location]
                                x,y=$x1,$y1
                                terrain=Chr
                            [/have_location]
                            [then]
                                #If at column castle, go to row castle
                                [if]
                                    {VARIABLE_CONDITIONAL x1 greater_than 4}
                                    [then]
                                        [remove_item]
                                        [/remove_item]
                                        
                                        [item]
                                             x,y=$x1,2-20
                                                                    image="terrain/alphamask.png~RC(000000>red)~O(60%)"
                                                                [/item]
                                                                

                                        [sound]
                                            name=magic-dark-miss.ogg
                                        [/sound]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [teleport]
                                            x,y=4,13
                                            [filter]
                                                x,y=$x1,$y1
                                            [/filter]
                                        [/teleport]
                                        [scroll_to_unit]
                                            id=Meneldur
                                        [/scroll_to_unit]
                                    [/then]

                                    #If at row castle, go to column castle
                                    [else]
                                        [remove_item]
                                        [/remove_item]
                                                                [item]
                                                                    x,y=2-20,$y1
                                                                    image="terrain/alphamask.png~RC(000000>green)~O(60%)"
                                                                [/item]

                                        [sound]
                                            name=magic-dark.ogg
                                        [/sound]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [teleport]
                                            x,y=13,22
                                            [filter]
                                                x,y=$x1,$y1
                                            [/filter]
                                        [/teleport]
                                        [scroll_to_unit]
                                            id=Meneldur
                                        [/scroll_to_unit]
                                    [/else]
                                [/if]
                            [/then]
                        [/if]

                        [if]
                            {VARIABLE_CONDITIONAL col greater_than 0}
                            {VARIABLE_CONDITIONAL row greater_than 0}
                            [then]
                                {CHECK_MOVE $col $row 1}
                            [/then]
                        [/if]

                        {IF_VAR valid_move equals yes (
                            [then]
                                [end_turn][/end_turn]
                            [/then]
                        )}
                    [/event]

                    [event]
                        name=side 1 turn end
                        first_time_only=no

                        {IF_VAR valid_move not_equals yes (
                            [then]
                                {CHECK_ALL_MOVES 1}
                            [/then]
                        )}

                        {MOVE_TO_BOARD (
                            [scroll_to]
                                x,y=$valid_x,$valid_y
                            [/scroll_to]
                            [delay]
                                time=1000
                            [/delay]
                            [sound]
                                name={SOUND_LIST:GRYPHON_HIT}
                            [/sound]
                            {VARIABLE n $turn_number}
                            {VARIABLE_OP n modulo 3}
                            [switch]
                                variable=n
                                [case]
                                    value=0
                                    {SE_RECALL_OR_CREATE_UNIT $valid_x $valid_y "Thief"}
                                [/case]
                                [else]
                                    {SE_RECALL_OR_CREATE_UNIT $valid_x $valid_y "Thug"}
                                [/else]
                            [/switch]
                            {CLEAR_VARIABLE n}
                            [delay]
                                time=500
                            [/delay]
                        )}
                        {CHECK_GAME_OVER}
                        {CLEAR_ITEMS}
                    [/event]

                    [event]
                        name=side 2 turn
                        first_time_only=no

                        #Find best AI move
                        {VARIABLE valid_move no}
                        {CHECK_ALL_MOVES 2}

                        {MOVE_TO_BOARD (
                            [scroll_to_unit]
                                id=Othello
                            [/scroll_to_unit]
                            [delay]
                                time=1000
                            [/delay]
                            {MOVE_UNIT (id=Othello) $valid_x 4}
                            [sound]
                                name=magic-dark-miss.ogg
                            [/sound]
                            [delay]
                                time=1000
                            [/delay]
                            [teleport]
                                x,y=22,13
                                [filter]
                                    id=Othello
                                [/filter]
                            [/teleport]
                            [scroll_to_unit]
                                id=Othello
                            [/scroll_to_unit]
                            [delay]
                                time=1000
                            [/delay]
                            {MOVE_UNIT (id=Othello) 22 $valid_y}
                            [delay]
                                time=1000
                            [/delay]
                            [scroll_to]
                                x=$valid_x
                                y=$valid_y
                            [/scroll_to]
                            [delay]
                                time=1000
                            [/delay]
                            [sound]
                                name={SOUND_LIST:ZOMBIE_HIT}
                            [/sound]
                            {VARIABLE n $turn_number}
                            {VARIABLE_OP n modulo 3}
                            [switch]
                                variable=n
                                [case]
                                    value=0
                                    {GENERIC_UNIT 2 "Ghoul" $valid_x $valid_y}
                                    [+unit]
                                        [variables]
                                            new_unit=yes
                                        [/variables]
                                    [/unit]
                                [/case]
                                [else]
                                    {GENERIC_UNIT 2 "Soulless" $valid_x $valid_y}
                                    [+unit]
                                        [variables]
                                            new_unit=yes
                                        [/variables]
                                    [/unit]
                                [/else]
                            [/switch]
                            {CLEAR_VARIABLE n}
                            [delay]
                                time=1000
                            [/delay]
                        )}
                        {CHECK_GAME_OVER}
                        [end_turn][/end_turn]
                    [/event]

                    ##clean the recall list of Meneldur
                    [event]
                        name=victory

                        [store_unit]
                            [filter]
                                side=1
                                type=Thief
                                [filter_wml]
                                    [variables]
                                        new_unit=yes
                                    [/variables]
                                [/filter_wml]
                            [/filter]
                            variable=thiefs
                        [/store_unit]

                        [store_unit]
                            [filter]
                                side=1
                                type=Thug
                                [filter_wml]
                                    [variables]
                                        new_unit=yes
                                    [/variables]
                                [/filter_wml]
                            [/filter]
                            variable=thugs
                        [/store_unit]

                        [store_unit]
                            [filter]
                                side=1
                                type=Soulless
                                [filter_wml]
                                    [variables]
                                        new_unit=yes
                                    [/variables]
                                [/filter_wml]
                            [/filter]
                            variable=zombies
                        [/store_unit]

                        [store_unit]
                            [filter]
                                side=1
                                type=Ghoul
                                [filter_wml]
                                    [variables]
                                        new_unit=yes
                                    [/variables]
                                [/filter_wml]
                            [/filter]
                            variable=ghouls
                        [/store_unit]

                        {FOREACH thiefs i}
                            {IF_VAR i greater_than 2 (
                                [then]
                                    [kill]
                                        id=$thiefs[$i].id
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}

                        {FOREACH thugs i}
                            {IF_VAR i greater_than 4 (
                                [then]
                                    [kill]
                                        id=$thugs[$i].id
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}

                        {FOREACH zombies i}
                            {IF_VAR i greater_than 2 (
                                [then]
                                    [kill]
                                        id=$zombies[$i].id
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}

                        {FOREACH ghouls i}
                            {IF_VAR i greater_than 4 (
                                [then]
                                    [kill]
                                        id=$ghouls[$i].id
                                    [/kill]
                                [/then]
                            )}
                        {NEXT i}
                        {CLEAR_VARIABLE thiefs,thugs,zombies,ghouls}
                    [/event]
                [/scenario]

#undef CLEAR_ITEMS
#undef CHECK_ALL_MOVES SIDE
#undef CHECK_DIR X Y SIDE X_DIR Y_DIR
#undef CHECK_MOVE X Y SIDE
#undef MOVE_TO_BOARD INSERT_CHECKER_WML
#undef CHECK_GAME_OVER
#undef SE_RECALL_OR_CREATE_UNIT X Y TYPE
